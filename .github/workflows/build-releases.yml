name: Build Cross-Platform Releases

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: true
        default: 'v1.0.0'

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows
            executable_name: labubu-launcher.exe
            python_version: '3.11'
          - os: macos-latest
            platform: macos
            executable_name: labubu-launcher
            python_version: '3.11'
          - os: ubuntu-latest
            platform: linux
            executable_name: labubu-launcher
            python_version: '3.11'

    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python_version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python_version }}

    - name: Install system dependencies (Ubuntu)
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -r requirements.txt

    - name: Build executable with PyInstaller
      run: |
        pyinstaller launcher.spec

    - name: Create distribution package (Windows)
      if: matrix.platform == 'windows'
      shell: pwsh
      run: |
        $VERSION = "${{ github.event.inputs.version || github.ref_name }}"
        $PACKAGE_NAME = "labubu-launcher-${{ matrix.platform }}-$VERSION"
        
        New-Item -ItemType Directory -Force -Path "dist/package"
        
        # Copy executable
        Copy-Item -Path "dist/${{ matrix.executable_name }}" -Destination "dist/package/" -Recurse
        
        # Copy configuration and documentation files
        Copy-Item -Path "config.yaml" -Destination "dist/package/"
        Copy-Item -Path "requirements.txt" -Destination "dist/package/"
        Copy-Item -Path "main.py" -Destination "dist/package/"
        
        # Create archive
        Set-Location "dist"
        Get-ChildItem -Name
        
        Compress-Archive -Path "package/*" -DestinationPath "$PACKAGE_NAME.zip" -Force
        
        # Set environment variables for next steps
        echo "PACKAGE_FILE=$PACKAGE_NAME.zip" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
        echo "PACKAGE_NAME=$PACKAGE_NAME" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

    - name: Create distribution package (Linux/macOS)
      if: matrix.platform != 'windows'
      shell: bash
      run: |
        VERSION="${{ github.event.inputs.version || github.ref_name }}"
        PACKAGE_NAME="labubu-launcher-${{ matrix.platform }}-${VERSION}"
        
        mkdir -p dist/package
        
        # Copy executable
        cp -r dist/${{ matrix.executable_name }} dist/package/
        chmod +x dist/package/${{ matrix.executable_name }}
        
        # Copy configuration and documentation files
        cp config.yaml dist/package/
        cp requirements.txt dist/package/
        cp main.py dist/package/
        
        # Create archive
        cd dist
        ls -lhs
        
        tar -czf ${PACKAGE_NAME}.tar.gz -C package .
        
        echo "PACKAGE_FILE=${PACKAGE_NAME}.tar.gz" >> $GITHUB_ENV
        echo "PACKAGE_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4.6.2
      with:
        name: ${{ env.PACKAGE_NAME }}
        path: dist/${{ env.PACKAGE_FILE }}

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v4.6.2
      with:
        path: artifacts

    - name: Create Release
      id: create_release
      uses: actions/create-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
      with:
        tag_name: ${{ github.event.inputs.version || github.ref_name }}
        release_name: LABUBUå¯åŠ¨å™¨ ${{ github.event.inputs.version || github.ref_name }}
        body: |
          # LABUBUå•†å“æœç´¢ç¨‹åº ${{ github.event.inputs.version || github.ref_name }}
          
          ## ğŸ“¦ ä¸‹è½½è¯´æ˜
          
          è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿä¸‹è½½å¯¹åº”çš„ç‰ˆæœ¬ï¼š
          
          - **Windowsç”¨æˆ·**ï¼šä¸‹è½½ `labubu-launcher-windows-*.zip`
          - **macOSç”¨æˆ·**ï¼šä¸‹è½½ `labubu-launcher-macos-*.tar.gz`  
          - **Linuxç”¨æˆ·**ï¼šä¸‹è½½ `labubu-launcher-linux-*.tar.gz`
          
          ## ğŸš€ å¿«é€Ÿå¼€å§‹
          
          1. ä¸‹è½½å¹¶è§£å‹å¯¹åº”å¹³å°çš„å‹ç¼©åŒ…
          2. è¿è¡Œå¯åŠ¨å™¨ç¨‹åºï¼ˆWindowsä¸‹åŒå‡».exeæ–‡ä»¶ï¼‰
          3. é¦–æ¬¡è¿è¡Œæ—¶æŒ‰æç¤ºç™»å½•æ·˜å®è´¦å·
          4. ç¨‹åºä¼šè‡ªåŠ¨å¼€å§‹ç›‘æ§ç›´æ’­é—´å•†å“
          
          ## âœ¨ åŠŸèƒ½ç‰¹æ€§
          
          - âœ… è·¨å¹³å°æ”¯æŒï¼ˆWindows/macOS/Linuxï¼‰
          - âœ… è‡ªåŠ¨ç¯å¢ƒæ£€æŸ¥å’Œä¾èµ–å®‰è£…
          - âœ… æ™ºèƒ½å•†å“æœç´¢å’Œç›‘æ§
          - âœ… æŒä¹…åŒ–ç™»å½•çŠ¶æ€
          - âœ… å¯é…ç½®çš„æœç´¢å…³é”®å­—å’Œç›‘æ§é—´éš”
          - âœ… å£°éŸ³æç¤ºåŠŸèƒ½
          
          ## ğŸ“ æ›´æ–°æ—¥å¿—
          
          - æ·»åŠ è·¨å¹³å°è‡ªåŠ¨æ„å»º
          - ä¼˜åŒ–å¯åŠ¨å™¨ç¯å¢ƒæ£€æŸ¥é€»è¾‘
          - æ”¹è¿›ç”¨æˆ·ä½“éªŒå’Œé”™è¯¯å¤„ç†
          
          **æ³¨æ„**ï¼šè¿™æ˜¯ä¸€ä¸ªæ¼”ç¤ºç¨‹åºï¼Œä¸ä¼šå®é™…æ‰§è¡Œè´­ä¹°æ“ä½œã€‚
        draft: false
        prerelease: false

    - name: Upload Release Assets
      run: |
        VERSION="${{ github.event.inputs.version || github.ref_name }}"
        
        for platform in windows macos linux; do
          artifact_dir="artifacts/labubu-launcher-${platform}-${VERSION}"
          if [ -d "$artifact_dir" ]; then
            for file in "$artifact_dir"/*; do
              if [ -f "$file" ]; then
                echo "Uploading $file..."
                gh release upload "$VERSION" "$file" --clobber
              fi
            done
          fi
        done
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
