name: Build Cross-Platform Releases

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: true
        default: 'v1.0.0'

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows
            executable_name: labubu-launcher.exe
            python_version: '3.11'
          - os: macos-latest
            platform: macos
            executable_name: labubu-launcher
            python_version: '3.11'
          - os: ubuntu-latest
            platform: linux
            executable_name: labubu-launcher
            python_version: '3.11'

    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python_version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python_version }}

    - name: Install system dependencies (Ubuntu)
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libnss3-dev libatk-bridge2.0-dev libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 libxrandr2 libgbm1 libxss1 libasound2

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -r requirements.txt

    - name: Install Playwright browsers
      run: |
        python -m playwright install chromium

    - name: Create launcher spec file
      run: |
        python -c "
import os
from pathlib import Path

spec_content = '''
# -*- mode: python ; coding: utf-8 -*-

block_cipher = None

a = Analysis(
    ['launcher.py'],
    pathex=[],
    binaries=[],
    datas=[
        ('config.yaml', '.'),
        ('requirements.txt', '.'),
        ('main.py', '.'),
    ],
    hiddenimports=[
        'playwright',
        'playwright._impl',
        'yaml',
        'asyncio',
        'logging',
        'subprocess',
        'platform',
        'urllib.request',
        'tempfile',
        'shutil',
        'json',
    ],
    hookspath=[],
    hooksconfig={},
    runtime_hooks=[],
    excludes=[],
    win_no_prefer_redirects=False,
    win_private_assemblies=False,
    cipher=block_cipher,
    noarchive=False,
)

pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

exe = EXE(
    pyz,
    a.scripts,
    a.binaries,
    a.zipfiles,
    a.datas,
    [],
    name='${{ matrix.executable_name }}',
    debug=False,
    bootloader_ignore_signals=False,
    strip=False,
    upx=True,
    upx_exclude=[],
    runtime_tmpdir=None,
    console=True,
    disable_windowed_traceback=False,
    argv_emulation=False,
    target_arch=None,
    codesign_identity=None,
    entitlements_file=None,
    icon=None,
)
'''

with open('launcher.spec', 'w', encoding='utf-8') as f:
    f.write(spec_content)
"

    - name: Build executable with PyInstaller
      run: |
        pyinstaller launcher.spec

    - name: Create distribution package
      shell: bash
      run: |
        VERSION="${{ github.event.inputs.version || github.ref_name }}"
        PACKAGE_NAME="labubu-launcher-${{ matrix.platform }}-${VERSION}"
        
        mkdir -p dist/package
        
        # Copy executable
        if [ "${{ matrix.platform }}" = "windows" ]; then
          cp dist/${{ matrix.executable_name }} dist/package/
        else
          cp dist/${{ matrix.executable_name }} dist/package/
          chmod +x dist/package/${{ matrix.executable_name }}
        fi
        
        # Copy configuration and documentation files
        cp config.yaml dist/package/
        cp requirements.txt dist/package/
        
        # Create README for thekage
        cat > dist/package/README.md << 'EOF'
        # LABUBUå•†å“æœç´¢ç¨‹åº

        ## ä½¿ç”¨è¯´æ˜

        1. **é¦–æ¬¡è¿è¡Œ**ï¼š
           - è¿è¡Œ `${{ matrix.executable_name }}`
           - ç¨‹åºä¼šè‡ªåŠ¨æ£€æŸ¥å’Œå®‰è£…å¿…è¦çš„ä¾èµ–
           - é¦–æ¬¡è¿è¡Œæ—¶éœ€è¦æ‰‹åŠ¨ç™»å½•æ·˜å®è´¦å·

        2. **é…ç½®è¯´æ˜**ï¼š
           - å¯ä»¥ç¼–è¾‘ `config.yaml` æ–‡ä»¶ä¿®æ”¹æœç´¢å…³é”®å­—å’Œç›‘æ§è®¾ç½®
           - æœç´¢å…³é”®å­—åœ¨ `search_keywords` éƒ¨åˆ†é…ç½®
           - ç›‘æ§é—´éš”åœ¨ `monitoring` éƒ¨åˆ†é…ç½®

        3. **æ³¨æ„äº‹é¡¹**ï¼š
           - è¿™æ˜¯ä¸€ä¸ªæ¼”ç¤ºç¨‹åºï¼Œä¸ä¼šå®é™…æ‰§è¡Œè´­ä¹°æ“ä½œ
           - ç¨‹åºä½¿ç”¨Playwrightè‡ªå¸¦çš„Chromiumæµè§ˆå™¨
           - ç™»å½•çŠ¶æ€ä¼šè¢«ä¿å­˜ï¼Œä¸‹æ¬¡å¯åŠ¨æ— éœ€é‡æ–°ç™»å½•

        ## ç³»ç»Ÿè¦æ±‚

        - ${{ matrix.platform == 'windows' && 'Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬' || matrix.platform == 'macos' && 'macOS 10.15 æˆ–æ›´é«˜ç‰ˆæœ¬' || 'Ubuntu 18.04 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œæˆ–å…¶ä»–å…¼å®¹çš„Linuxå‘è¡Œç‰ˆ' }}
        - è‡³å°‘2GBå¯ç”¨å†…å­˜
        - ç¨³å®šçš„ç½‘ç»œè¿æ¥

        ## æŠ€æœ¯æ”¯æŒ

        å¦‚é‡é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
        1. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
        2. é˜²ç«å¢™æ˜¯å¦é˜»æ­¢ç¨‹åºè¿è¡Œ
        3. ç³»ç»Ÿæ˜¯å¦æœ‰è¶³å¤Ÿçš„æƒé™å’Œå­˜å‚¨ç©ºé—´
        EOF
        
        # Create archive
        cd dist
        if [ "${{ matrix.platform }}" = "windows" ]; then
          powershell Compress-Archive -Path package/* -DestinationPath ${PACKAGE_NAME}.zip
          echo "PACKAGE_FILE=${PACKAGE_NAME}.zip" >> $GITHUB_ENV
        else
          tar -czf ${PACKAGE_NAME}.tar.gz -C package .
          echo "PACKAGE_FILE=${PACKAGE_NAME}.tar.gz" >> $GITHUB_ENV
        fi
        
        echo "PACKAGE_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ${{ env.PACKAGE_NAME }}
        path: dist/${{ env.PACKAGE_FILE }}

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v3
      with:
        path: artifacts

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.event.inputs.version || github.ref_name }}
        release_name: LABUBUå¯åŠ¨å™¨ ${{ github.event.inputs.version || github.ref_name }}
        body: |
          # LABUBUå•†å“æœç´¢ç¨‹åº ${{ github.event.inputs.version || github.ref_name }}
          
          ## ğŸ“¦ ä¸‹è½½è¯´æ˜
          
          è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿä¸‹è½½å¯¹åº”çš„ç‰ˆæœ¬ï¼š
          
          - **Windowsç”¨æˆ·**ï¼šä¸‹è½½ `labubu-launcher-windows-*.zip`
          - **macOSç”¨æˆ·**ï¼šä¸‹è½½ `labubu-launcher-macos-*.tar.gz`  
          - **Linuxç”¨æˆ·**ï¼šä¸‹è½½ `labubu-launcher-linux-*.tar.gz`
          
          ## ğŸš€ å¿«é€Ÿå¼€å§‹
          
          1. ä¸‹è½½å¹¶è§£å‹å¯¹åº”å¹³å°çš„å‹ç¼©åŒ…
          2. è¿è¡Œå¯åŠ¨å™¨ç¨‹åºï¼ˆWindowsä¸‹åŒå‡».exeæ–‡ä»¶ï¼‰
          3. é¦–æ¬¡è¿è¡Œæ—¶æŒ‰æç¤ºç™»å½•æ·˜å®è´¦å·
          4. ç¨‹åºä¼šè‡ªåŠ¨å¼€å§‹ç›‘æ§ç›´æ’­é—´å•†å“
          
          ## âœ¨ åŠŸèƒ½ç‰¹æ€§
          
          - âœ… è·¨å¹³å°æ”¯æŒï¼ˆWindows/macOS/Linuxï¼‰
          - âœ… è‡ªåŠ¨ç¯å¢ƒæ£€æŸ¥å’Œä¾èµ–å®‰è£…
          - âœ… æ™ºèƒ½å•†å“æœç´¢å’Œç›‘æ§
          - âœ… æŒä¹…åŒ–ç™»å½•çŠ¶æ€
          - âœ… å¯é…ç½®çš„æœç´¢å…³é”®å­—å’Œç›‘æ§é—´éš”
          - âœ… å£°éŸ³æç¤ºåŠŸèƒ½
          
          ## ğŸ“ æ›´æ–°æ—¥å¿—
          
          - æ·»åŠ è·¨å¹³å°è‡ªåŠ¨æ„å»º
          - ä¼˜åŒ–å¯åŠ¨å™¨ç¯å¢ƒæ£€æŸ¥é€»è¾‘
          - æ”¹è¿›ç”¨æˆ·ä½“éªŒå’Œé”™è¯¯å¤„ç†
          
          **æ³¨æ„**ï¼šè¿™æ˜¯ä¸€ä¸ªæ¼”ç¤ºç¨‹åºï¼Œä¸ä¼šå®é™…æ‰§è¡Œè´­ä¹°æ“ä½œã€‚
        draft: false
        prerelease: false

    - name: Upload Release Assets
      run: |
        VERSION="${{ github.event.inputs.version || github.ref_name }}"
        
        for platform in windows macos linux; do
          artifact_dir="artifacts/labubu-launcher-${platform}-${VERSION}"
          if [ -d "$artifact_dir" ]; then
            for file in "$artifact_dir"/*; do
              if [ -f "$file" ]; then
                echo "Uploading $file..."
                gh release upload "$VERSION" "$file" --clobber
              fi
            done
          fi
        done
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}